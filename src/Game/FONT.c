#include "Game/FONT.h"
#include "Game/MEMPACK.h"
#include "Game/LOAD3D.h"
#include "Game/VRAM.h"

FontPos fontPos[] =
{
    { 0x00, 0x00, 0x0B, 0x0C },
    { 0x0B, 0x00, 0x08, 0x0C },
    { 0x14, 0x00, 0x08, 0x0C },
    { 0x1C, 0x00, 0x09, 0x0C },
    { 0x25, 0x00, 0x08, 0x0C },
    { 0x2D, 0x00, 0x08, 0x0C },
    { 0x35, 0x00, 0x0A, 0x0C },
    { 0x00, 0x0C, 0x09, 0x0C },
    { 0x09, 0x0C, 0x03, 0x0C },
    { 0x2A, 0x0C, 0x05, 0x0C },
    { 0x2F, 0x0D, 0x08, 0x0B },
    { 0x01, 0x6F, 0x07, 0x0C },
    { 0x00, 0x1A, 0x0A, 0x0C },
    { 0x0B, 0x1A, 0x08, 0x0C },
    { 0x13, 0x1A, 0x0A, 0x0C },
    { 0x1D, 0x1A, 0x07, 0x0C },
    { 0x2E, 0x1A, 0x08, 0x0C },
    { 0x00, 0x27, 0x09, 0x0C },
    { 0x0A, 0x27, 0x09, 0x0C },
    { 0x13, 0x27, 0x08, 0x0B },
    { 0x1B, 0x27, 0x09, 0x0B },
    { 0x25, 0x27, 0x0A, 0x0C },
    { 0x2F, 0x27, 0x08, 0x0C },
    { 0x01, 0x33, 0x09, 0x0D },
    { 0x0A, 0x33, 0x08, 0x0D },
    { 0x12, 0x33, 0x08, 0x0D },
    { 0x1B, 0x33, 0x07, 0x0D },
    { 0x23, 0x33, 0x08, 0x0D },
    { 0x2C, 0x33, 0x07, 0x0D },
    { 0x34, 0x33, 0x07, 0x0C },
    { 0x0C, 0x0C, 0x08, 0x0C },
    { 0x14, 0x0C, 0x07, 0x0C },
    { 0x21, 0x0C, 0x07, 0x0C },
    { 0x3D, 0x20, 0x03, 0x03 },
    { 0x3D, 0x33, 0x02, 0x0D },
    { 0x36, 0x19, 0x07, 0x0C },
    { 0x30, 0x05, 0x05, 0x07 },
    { 0x1B, 0x0C, 0x05, 0x0C },
    { 0x39, 0x27, 0x06, 0x0B },
    { 0x3D, 0x1A, 0x03, 0x0A },
    { 0x13, 0x1A, 0x05, 0x0C },
    { 0x18, 0x1A, 0x05, 0x0B },
    { 0x10, 0x64, 0x07, 0x0A },
    { 0x31, 0x66, 0x08, 0x07 },
    { 0x31, 0x25, 0x05, 0x0C },
    { 0x20, 0x40, 0x07, 0x0C },
    { 0x24, 0x19, 0x09, 0x05 },
    { 0x14, 0x46, 0x05, 0x04 },
    { 0x00, 0x40, 0x08, 0x0A },
    { 0x28, 0x40, 0x07, 0x0C },
    { 0x3D, 0x33, 0x02, 0xF3 },
    { 0x25, 0x1E, 0x08, 0x02 },
    { 0x12, 0x40, 0x07, 0x04 },
    { 0x0A, 0x40, 0x06, 0x05 },
    { 0x0A, 0x46, 0x06, 0x05 },
    { 0x24, 0x19, 0x08, 0x04 },
    { 0x1B, 0x47, 0x05, 0x04 },
    { 0x2F, 0x40, 0x0B, 0x0C },
    { 0x00, 0x4D, 0x0C, 0x0C },
    { 0x0C, 0x4D, 0x0C, 0x0C },
    { 0x18, 0x4D, 0x0C, 0x0C },
    { 0x24, 0x4D, 0x0C, 0x0C },
    { 0x30, 0x4D, 0x0A, 0x0C },
    { 0x30, 0x4B, 0x0A, 0xF4 },
    { 0x00, 0x59, 0x0C, 0x0B },
    { 0x00, 0x59, 0xF4, 0x0B },
    { 0x0D, 0x59, 0x0E, 0x0B },
    { 0x1C, 0x59, 0x0E, 0x0B },
    { 0x2B, 0x59, 0x0E, 0x0B },
    { 0x01, 0x64, 0x0E, 0x0B },
    { 0x1A, 0x64, 0x09, 0x0B },
    { 0x24, 0x64, 0x0C, 0x0B }
};

char charMap[][3] =
{
    { 0x00, 0xFF, 0xFF },
    { 0x01, 0xFF, 0xFF },
    { 0x02, 0xFF, 0xFF },
    { 0x03, 0xFF, 0xFF },
    { 0x04, 0xFF, 0xFF },
    { 0x05, 0xFF, 0xFF },
    { 0x06, 0xFF, 0xFF },
    { 0x07, 0xFF, 0xFF },
    { 0x08, 0xFF, 0xFF },
    { 0x09, 0xFF, 0xFF },
    { 0x0A, 0xFF, 0xFF },
    { 0x0B, 0xFF, 0xFF },
    { 0x0C, 0xFF, 0xFF },
    { 0x0D, 0xFF, 0xFF },
    { 0x0E, 0xFF, 0xFF },
    { 0x0F, 0xFF, 0xFF },
    { 0x39, 0xFF, 0xFF },
    { 0x10, 0xFF, 0xFF },
    { 0x11, 0xFF, 0xFF },
    { 0x12, 0xFF, 0xFF },
    { 0x13, 0xFF, 0xFF },
    { 0x14, 0xFF, 0xFF },
    { 0x15, 0xFF, 0xFF },
    { 0x16, 0xFF, 0xFF },
    { 0x17, 0xFF, 0xFF },
    { 0x18, 0xFF, 0xFF },
    { 0x0E, 0xFF, 0xFF },
    { 0x08, 0xFF, 0xFF },
    { 0x19, 0xFF, 0xFF },
    { 0x1A, 0xFF, 0xFF },
    { 0x1B, 0xFF, 0xFF },
    { 0x1C, 0xFF, 0xFF },
    { 0x1D, 0xFF, 0xFF },
    { 0x1E, 0xFF, 0xFF },
    { 0x1F, 0xFF, 0xFF },
    { 0x20, 0xFF, 0xFF },
    { 0x21, 0xFF, 0xFF },
    { 0x22, 0xFF, 0xFF },
    { 0x23, 0xFF, 0xFF },
    { 0x24, 0xFF, 0xFF },
    { 0x25, 0xFF, 0xFF },
    { 0x26, 0xFF, 0xFF },
    { 0x27, 0xFF, 0xFF },
    { 0x28, 0xFF, 0xFF },
    { 0x29, 0xFF, 0xFF },
    { 0x2A, 0xFF, 0xFF },
    { 0x2B, 0xFF, 0xFF },
    { 0x2C, 0xFF, 0xFF },
    { 0x2D, 0xFF, 0xFF },
    { 0x2E, 0xFF, 0xFF },
    { 0x2F, 0xFF, 0xFF },
    { 0xFF, 0xFF, 0x2F },
    { 0x02, 0x2F, 0xFF },
    { 0x13, 0xFF, 0x33 },
    { 0x04, 0xFF, 0x35 },
    { 0x00, 0xFF, 0x36 },
    { 0x00, 0xFF, 0x33 },
    { 0x00, 0xFF, 0x34 },
    { 0x30, 0xFF, 0xFF },
    { 0x04, 0xFF, 0x36 },
    { 0x04, 0xFF, 0x33 },
    { 0x04, 0xFF, 0x34 },
    { 0x08, 0xFF, 0x33 },
    { 0x08, 0xFF, 0x36 },
    { 0x08, 0xFF, 0x34 },
    { 0x0E, 0xFF, 0x36 },
    { 0x0E, 0xFF, 0x33 },
    { 0x0E, 0xFF, 0x34 },
    { 0x13, 0xFF, 0x36 },
    { 0x13, 0xFF, 0x34 },
    { 0x17, 0xFF, 0x33 },
    { 0x00, 0xFF, 0x35 },
    { 0x08, 0xFF, 0x35 },
    { 0x0E, 0xFF, 0x35 },
    { 0x13, 0xFF, 0x35 },
    { 0x0D, 0xFF, 0x37 },
    { 0x31, 0xFF, 0xFF },
    { 0x32, 0xFF, 0xFF },
    { 0x3A, 0xFF, 0xFF },
    { 0x3B, 0xFF, 0xFF },
    { 0x3C, 0xFF, 0xFF },
    { 0x3D, 0xFF, 0xFF },
    { 0x3E, 0xFF, 0xFF },
    { 0x3F, 0xFF, 0xFF },
    { 0x40, 0xFF, 0xFF },
    { 0x41, 0xFF, 0xFF },
    { 0x42, 0xFF, 0xFF },
    { 0x43, 0xFF, 0xFF },
    { 0x44, 0xFF, 0xFF },
    { 0x45, 0xFF, 0xFF },
    { 0x46, 0xFF, 0xFF },
    { 0x47, 0xFF, 0xFF }
};

unsigned char fontTransTable[128];

static char fp_str[512];

STATIC font_color_t the_font_color_table[5];

BlockVramEntry *FONT_vramBlock;

void FONT_MakeSpecialFogClut(int x, int y)
{

    int n;
    short cl[16];
    RECT myrect;

    for (n = 0; n < 16; n++)
    {
        cl[n] = 0x4210;
    }

    cl[0] = 0;

    myrect.x = x;
    myrect.y = y;
    myrect.w = 0x10;
    myrect.h = 1;

    SpecialFogClut = getClut(x, y);
    DrawSync(0);
    LoadImage(&myrect, (u_long *)cl);
    DrawSync(0);
}

extern char D_800D0674[];
void FONT_Init()
{
    unsigned long *timAddr;
    short x;
    short y;

    FONT_vramBlock = VRAM_CheckVramSlot(&x, &y, 16, 128, 3, -1);

    if (FONT_vramBlock != NULL)
    {
        // timAddr = LOAD_ReadFile("\\kain2\\game\\font.tim", 5);
        timAddr = (unsigned long *)LOAD_ReadFile(D_800D0674, 5);

        LOAD_LoadTIM((long *)timAddr, x, y, x, y + 126);

        MEMPACK_Free((char *)timAddr);

        fontTracker.sprite_sort_push = 0;

        fontTracker.font_tpage = getTPage(0, 0, x, y);
        fontTracker.font_clut = getClut(x, y + 126);

        fontTracker.font_vramX = x;
        fontTracker.font_vramY = y;

        fontTracker.font_vramU = (x & 0x3F) * 4;
        fontTracker.font_vramV = y & 0xFF;

        FONT_MakeSpecialFogClut(x, y + 127);
    }

    fontTracker.font_xpos = 10;
    fontTracker.font_ypos = 16;

    fontTracker.font_buffIndex = 0;

    fontTracker.sprite_sort_push = 0;

    fontTracker.color_global = 0;
    fontTracker.color_local = 0;
}

void FONT_ReloadFont()
{
    unsigned long *timAddr;

    timAddr = (unsigned long *)LOAD_ReadFile(D_800D0674, 5);
    // timAddr = (unsigned long*)LOAD_ReadFile("\\kain2\\game\\font.tim", 5);

    LOAD_LoadTIM((long *)timAddr, fontTracker.font_vramX, fontTracker.font_vramY, fontTracker.font_vramX, fontTracker.font_vramY + 126);

    MEMPACK_Free((char *)timAddr);

    FONT_MakeSpecialFogClut(fontTracker.font_vramX, fontTracker.font_vramY + 127);
}

void FONT_DrawChar(FontChar *fontChar)
{

    char c;
    long x;
    long y;

    c = fontChar->c;
    x = fontChar->x;
    y = fontChar->y;
    fontTracker.color_local = fontChar->color;

    FONT_DrawChar2D(c & 0xFF, x, y);
}

long FONT_Get2DImageIndex(unsigned char c)
{
    return fontTransTable[c];
}

INCLUDE_ASM("asm/nonmatchings/Game/FONT", drawChar2DPoly);

INCLUDE_ASM("asm/nonmatchings/Game/FONT", FONT_DrawChar2D);

INCLUDE_ASM("asm/nonmatchings/Game/FONT", FONT_CharSpacing);

void FONT_AddCharToBuffer(char c, long x, long y)
{
    FontChar *fontChar;

    fontChar = &fontTracker.font_buffer[fontTracker.font_buffIndex];

    if (fontTracker.font_buffIndex < 255)
    {
        if (c == '@')
        {
            fontChar->x = x & 0xFF;
            fontChar->y = y & 0xFF;
        }
        else
        {
            fontChar->x = x;
            fontChar->y = y;
        }

        fontChar->c = c;

        fontTracker.font_buffIndex++;

        fontChar->color = fontTracker.color_global;
    }
}

void FONT_Print(const char *fmt, ...)
{
    char *hold;
    va_list ap;

    va_start(ap, fmt);

    vsprintf(fp_str, fmt, ap);

    for (hold = fp_str; *hold != '\0'; hold++)
    {
        if ((*hold >= 'A') && (*hold <= 'Z'))
        {
            *hold += 'a' - 'A';
        }
    }

    FONT_VaReallyPrint(fp_str, ap);

    va_end(ap);
}

void FONT_Print2(const char *fmt, ...)
{
    va_list ap;

    va_start(ap, fmt);

    vsprintf(fp_str, fmt, ap);

    FONT_VaReallyPrint(fp_str, ap);

    va_end(ap);
}

int FONT_GetStringWidth(char *str)
{
    int w;
    int len;
    int i;

    len = strlen(str);

    w = 0;

    for (i = 0; i < len; i++)
    {
        w += FONT_CharSpacing(str[i], 8);
    }

    return w;
}

void FONT_Flush()
{
    long i;
    FontChar *fontChar;

    fontTracker.font_xpos = 10;
    fontTracker.font_ypos = 16;

    if (fontTracker.font_buffIndex == 0)
    {
        return;
    }

    fontChar = fontTracker.font_buffer;

    for (i = fontTracker.font_buffIndex; i != 0; i--, fontChar++)
    {
        if ((fontChar->c != ' ') && (fontChar->c != '@'))
        {
            FONT_DrawChar(fontChar);
        }
    }

    fontTracker.font_buffIndex = 0;
}

void FONT_SetCursor(short x, short y)
{
    fontTracker.font_xpos = x;
    fontTracker.font_ypos = y;
}

INCLUDE_ASM("asm/nonmatchings/Game/FONT", FONT_VaReallyPrint);

void FONT_FontPrintCentered(char *text, long y)
{
    FONT_SetCursor((512 / 2) - (FONT_GetStringWidth(text) >> 1), y);

    FONT_Print2(text);
}

void FONT_SetColorIndex(int color)
{
    fontTracker.color_global = color;
}

void FONT_SetColorIndexCol(int color, int r, int g, int b)
{
    font_color_t *fcol;

    fcol = &the_font_color_table[color];

    fcol->r = r;
    fcol->g = g;
    fcol->b = b;
}
